trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  buildConfiguration: 'Release'
  dotnetVersion: '8.x'
  projectPath: 'CSharpRag/CSharpRagApp/CSharpRagApp.csproj'
  azureSubscription: '<YOUR_AZURE_SERVICE_CONNECTION>'
  uatAppServiceName: '<YOUR_UAT_APP_SERVICE_NAME>'
  stagingAppServiceName: '<YOUR_STAGING_APP_SERVICE_NAME>'
  productionAppServiceName: '<YOUR_PRODUCTION_APP_SERVICE_NAME>'

stages:
  # ──────────────────────────────────────────────
  # Stage 1: Build & Publish Artifact
  # ──────────────────────────────────────────────
  - stage: Build
    displayName: 'Build'
    jobs:
      - job: Build
        displayName: 'Build and Publish'
        steps:
          - task: UseDotNet@2
            displayName: 'Install .NET SDK'
            inputs:
              packageType: 'sdk'
              version: '$(dotnetVersion)'

          - task: DotNetCoreCLI@2
            displayName: 'Restore NuGet Packages'
            inputs:
              command: 'restore'
              projects: '$(projectPath)'

          - task: DotNetCoreCLI@2
            displayName: 'Build'
            inputs:
              command: 'build'
              projects: '$(projectPath)'
              arguments: '--configuration $(buildConfiguration) --no-restore'

          - task: DotNetCoreCLI@2
            displayName: 'Run Tests'
            inputs:
              command: 'test'
              projects: 'CSharpRag/CSharpRagApp.Tests/CSharpRagApp.Tests.csproj'
              arguments: '--configuration $(buildConfiguration) --no-build'
            continueOnError: true

          - task: DotNetCoreCLI@2
            displayName: 'Publish'
            inputs:
              command: 'publish'
              projects: '$(projectPath)'
              arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)'
              publishWebProjects: false
              zipAfterPublish: true

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Artifact'
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: 'drop'

  # ──────────────────────────────────────────────
  # Stage 2: Deploy to UAT
  # ──────────────────────────────────────────────
  - stage: Deploy_UAT
    displayName: 'Deploy to UAT'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: Deploy_UAT
        displayName: 'Deploy to UAT'
        environment: 'uat'           # Configure approval gate on this environment in Azure DevOps
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureWebApp@1
                  displayName: 'Deploy to UAT App Service'
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    appType: 'webAppLinux'
                    appName: '$(uatAppServiceName)'
                    package: '$(Pipeline.Workspace)/drop/**/*.zip'
                    runtimeStack: 'DOTNETCORE|8.0'

  # ──────────────────────────────────────────────
  # Stage 3: Deploy to Staging (requires approval)
  # ──────────────────────────────────────────────
  - stage: Deploy_Staging
    displayName: 'Deploy to Staging'
    dependsOn: Deploy_UAT
    condition: succeeded()
    jobs:
      - deployment: Deploy_Staging
        displayName: 'Deploy to Staging'
        environment: 'staging'       # Configure approval gate on this environment in Azure DevOps
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureWebApp@1
                  displayName: 'Deploy to Staging App Service'
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    appType: 'webAppLinux'
                    appName: '$(stagingAppServiceName)'
                    package: '$(Pipeline.Workspace)/drop/**/*.zip'
                    runtimeStack: 'DOTNETCORE|8.0'

  # ──────────────────────────────────────────────
  # Stage 4: Deploy to Production (requires approval)
  # ──────────────────────────────────────────────
  - stage: Deploy_Production
    displayName: 'Deploy to Production'
    dependsOn: Deploy_Staging
    condition: succeeded()
    jobs:
      - deployment: Deploy_Production
        displayName: 'Deploy to Production'
        environment: 'production'    # Configure approval gate on this environment in Azure DevOps
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureWebApp@1
                  displayName: 'Deploy to Production App Service'
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    appType: 'webAppLinux'
                    appName: '$(productionAppServiceName)'
                    package: '$(Pipeline.Workspace)/drop/**/*.zip'
                    runtimeStack: 'DOTNETCORE|8.0'
